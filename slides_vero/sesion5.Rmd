---
title: "Visualizaci√≥n de datos con `ggplot2`"
subtitle: "Fundaci√≥n Paz Ciudadana"
author: "Ignacio Agloni, Ver√≥nica Canales, Klaus Lehmann"
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    self_contained: true
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r,setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
#xaringan::summon_remark()
library(tidyverse)
```

## Objetivos de la sesi√≥n

Esta sesi√≥n se divide en dos:

**Primera parte**:

- Utilizar nociones b√°sicas de datos ordenados para la manipulaci√≥n de `data frames`.

--

**Segunda parte**:

- Conocer nociones b√°sicas para la creaci√≥n de gr√°ficos claros y precisos.

- Graficar datos usando el paquete `ggplot2`.

--

En esta sesi√≥n trabajaremos con los datos del **Se√±or de los Anillos**, **ENUSC 2017** y la *data frame* del paquete `gapminder`.

---

background-image: url(https://media.giphy.com/media/3ELDuBKag7o8E/giphy.gif)
background-size: cover
class: center, bottom, inverse

# Datos ordenados

---

## Datos ordenados


.pull-left[
> "In my experience the vast majority of graphing agony is due to insufficient data wrangling".

> "Behind every great plot there's a great deal of wrangling"

]

.pull-right[
![](https://user2018.r-project.org/img/testimonials/jenny.png)
]

---

## Datos ordenados

Algunas reglas a considerar (de acuerdo a Jenny Bryan):

.pull-left[
- Usa `data.frames`

- Se el jefe de tus factores

- Manten tus datos ordenados

- Reestructura tus datos
]

--

.pull-right[
- ¬°Hecho!

- `forcats` üêà

- ¬ø?

- ¬ø?¬ø?
]

--

.center[A√∫n nos falta revisar c√≥mo mantener nuestros datos ordenados y c√≥mo reestructurarlos cuando sea necesario.
]

--

.center[
Antes de comenzar a ver gr√°ficos, necesitamos conocer c√≥mo mantener nuestros datos ordenados.]

---

## Datos ordenados

Las tablas de datos o *data frames* son la estructura de datos m√°s usadas en estad√≠sticas y ciencias sociales.

--

A pesar de su popularidad, trabajar con este tipo de datos muchas veces consume mucho de nuestro tiempo ‚è≥‚è∞

--

### ¬øPor qu√© nos toma tanto tiempo ordenar datos?

--

Porque hay muchas maneras de ~~ser desordenado~~ representar la informaci√≥n contenida en una tabla de datos.

???
Algunos dicen que pasamos un 80% de nuestro tiempo ordenando nuestros datos, y un 20% quej√°ndonos porque tenemos que ordenar.

---

## Datos ordenados

`Tidyverse` tiene varias herramientas para lidiar con esta heterogeneidad.

![](https://pbs.twimg.com/media/DxzqktwUcAAYCLT.jpg)

--

Pero, ¬øqu√© significa  ordenar nuestros datos?

---

## Datos ordenados

En t√©rminos sencillos, el concepto de datos ordenados (*tidy data*) puede ser descrito en base a 3 principios:

--

- Cada variable forma una columna.

--

- Cada observaci√≥n forma una fila.

--

- Cada valor debe tener su propia celda.

--

[Wickham, H, (2014). *Tidy data*. Journal of Statistical Software ](https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=1&ved=2ahUKEwjj7vHk6MPgAhXxY98KHSfyBIYQFjAAegQIBxAC&url=https%3A%2F%2Fwww.jstatsoft.org%2Farticle%2Fview%2Fv059i10%2Fv59i10.pdf&usg=AOvVaw2vJ6CHw9RT8m_noVUfoeP6)

![](https://cdn-images-1.medium.com/max/1600/1*_64CzT-YicPKgCEJsOi6_A.png)

---

## Datos ordenados

**¬øY qu√© nos ofrece `tidyverse` cuando los datos no vienen ordenados?** (O no est√°n ordenados como yo quiero).

--

Veamos un ejemplo concreto. Obviamente no es representativo de la inmensa diversidad de problemas que nos enfrentamos para ordenar los datos...

--

Este ejemplo es prestado de las clases de Jenny Bryan: [Data wrangling, exploration, and analysis with R](https://stat545.com/index.html)

--

### *Data frame*: El Se√±or de los Anillos

.center[
![](https://2.bp.blogspot.com/-tyklFIlKXus/WarNQUvEmEI/AAAAAAABBoU/_ZHWRNxTjRcTgss2OS3htEkGRUwCGs9TwCLcBGAs/s1600/C-50.gif)
]

---

## El Se√±or de los Anillos

Tenemos la siguiente informaci√≥n para cada pel√≠cula de la trilog√≠a de Tolkien separada en 3 tablas:

```{r, fig.align='center', echo=FALSE}
knitr::include_graphics("thelord.png")
```

En cada tabla tenemos el n√∫mero total de palabras dichas por cada personaje, separado por raza y sexo.

--

¬øQu√© sucede si queremos saber el n√∫mero total de palabras dichas por hobbits de sexo masculino? 

¬øO si queremos saber si una raza domina en una pel√≠cula?

---

## El Se√±or de los Anillos

```{r, fig.align='center', echo=FALSE}
knitr::include_graphics("thelord.png")
```

En realidad es muy sencillo, solo tendr√≠amos que sumar las celdas... Pero si luego queremos graficar los datos utilizando un paquete estad√≠stico como SPSS o Stata, ya no es tan intuituva la respuesta.

--

¬°Tenemos que ordenar los datos!

---

```{r}
comunidad <- tribble(
  ~race, ~female, ~male,
  "Elf", 1229, 971,
  "Hobbit", 14, 3644,
  "Man", 0, 1995)
comunidad <- add_column(comunidad, film = 
            "The Fellowship Of The Ring", .before = "race")

dos_torres <- tribble(
  ~race, ~female, ~male,
  "Elf", 331, 513,
  "Hobbit", 0, 2463,
  "Man", 401, 3589)
dos_torres <- add_column(dos_torres, film = 
             "Two Towers", .before = "race")

retorno_rey <- tribble(
  ~race, ~female, ~male,
  "Elf", 183, 510,
  "Hobbit", 2, 2673,
  "Man", 268, 2459)
retorno_rey <- add_column(retorno_rey, film = 
              "The Return Of The King", .before = "race")

the_lord_of_the_rings <- rbind(
  comunidad, dos_torres, retorno_rey)
```

---

## El Se√±or de los Anillos

¬øC√≥mo deber√≠a verse esta tabla para que estuviese ordenada?

--

**Pista**: ¬øQu√© es *male* y *female*? ¬øSon variables?

--

Las columnas *male* y *female* son valores, no son variables.

Es necesario reunir esos valores para formar una columna que si corresponda a una variable.

--

Esto se ver√≠a m√°s o menos as√≠:

```{r, echo=FALSE}
head(the_lord_of_the_rings %>% gather(female:male, key = "sex", value = "words"), 6)
```

Veamos como hacemos esto con c√≥digo.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/5f8c22ec53a1ac61684f3e8d59c623d09227d6b9/b15de/images/hex-tidyr.png)
background-size: 75px
background-position: 93% 8%

## `tidyr::gather`

`gather` permite reunir la informaci√≥n de distintas columnas, para formar un nuevo par de variables ordenado.

--

Para utilizar la funci√≥n debemos:

- Identificar qu√© columnas queremos reordenar.

- Definir un nombre para la variable cuyos valores ahora son los nombres de las columnas que queremos reorganizar.

- Definir un nombre para los valores que est√°n bajo esas columnas.

--

Con esto tenemos los principales par√°metros de la funci√≥n `gather`

```{r, echo=TRUE, include=TRUE}
str(tidyr::gather)
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/5f8c22ec53a1ac61684f3e8d59c623d09227d6b9/b15de/images/hex-tidyr.png)
background-size: 75px
background-position: 93% 8%

## `tidyr::gather`

```{r, eval=FALSE, echo=TRUE}
the_lord_of_the_rings  %>% 
  gather(female:male, key = "sex", value = "words")
```

```{r, echo=FALSE, include=TRUE}
head(gather(data = the_lord_of_the_rings, female:male, key = "sex", value = "words"), 10)
the_lord_of_the_rings <- the_lord_of_the_rings %>% 
  gather(female:male, key = "sex", value = "words")
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/5f8c22ec53a1ac61684f3e8d59c623d09227d6b9/b15de/images/hex-tidyr.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 1

¬°Ahora Uds! ¬øC√≥mo reordenar√≠an la siguiente tabla con `gather()`?

```{r}
table4a
```

**¬°Para que el c√≥digo funcione!**: Es necesario escribir 1999 y 2000 como sigue:

```{r, eval=FALSE}
`1999`
`2000`
```

Las `tibbles` admiten como nombre de variables caracteres que no son v√°lidos para los `data.frame`. Es por esto que los n√∫meros pueden ser nombres de variables.


---

background-image: url(https://d33wubrfki0l68.cloudfront.net/5f8c22ec53a1ac61684f3e8d59c623d09227d6b9/b15de/images/hex-tidyr.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 1 - Soluci√≥n

```{r}
table4a %>%
  gather(`1999`, `2000`, key = "year", value = "cases")
```

--

![](http://garrettgman.github.io/images/tidy-9.png)

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/5f8c22ec53a1ac61684f3e8d59c623d09227d6b9/b15de/images/hex-tidyr.png)
background-size: 75px
background-position: 93% 8%

## `tidyr::spread`

La funci√≥n `spread()` es opuesta a la funci√≥n `gather()`. 

--

A diferencia de `gather()`, `spread()` se utiliza cuando una observaci√≥n est√° repartida en diferentes filas.

--

```{r}
table2
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/5f8c22ec53a1ac61684f3e8d59c623d09227d6b9/b15de/images/hex-tidyr.png)
background-size: 75px
background-position: 93% 8%

## `tidyr::spread`

¬øUsemos `spread()` para "desordenar" los datos que ordenamos del Se√±or de los Anillos?

--

La funci√≥n `spread()` necesita de dos param√©tros:

- La columna que contiene los nombres de las variables (`key`).

- La columna que contiene los valores de distintas variables (`value`).

**¬øC√≥mo lo har√≠an para tener una variable por raza?**

```{r, eval=FALSE}
the_lord_of_the_rings %>%
  spread(key = ..., value = ...)
```

--

```{r, eval=FALSE}
the_lord_of_the_rings %>%
  spread(key = "race", value = "words")
```

---

background-image: url(https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/rstats-artwork/ggplot2_masterpiece.png)
background-size: cover
class: center, bottom, inverse

# ¬°Ahora s√≠ podemos pasar a los gr√°ficos!

---

## La importancia de la visualizaci√≥n

La visualizaci√≥n juega un rol importante en las etapas del an√°lisis de datos:

- Exploraci√≥n

- Modelamiento

- Diagn√≥stico

--

> "The simple graph has brought more information to the data analyst's mind than any other device." - John Tukey

--

**Los gr√°ficos nos permiten comunicar y atraer la atenci√≥n de una audiencia**: [The Joy of Stats](https://www.youtube.com/watch?v=V8lbiiTF2P0)

???
Los principales objetivos de los gr√°ficos en estad√≠stica son: 
i) facilitar comparaciones
ii) identificar tendencias

---

## The Datasaurus Dozen [Matejka & Fitzmaurice, 2017](https://www.autodeskresearch.com/publications/samestats)

.center[
![](https://raw.githubusercontent.com/rweekly/image/master/2017-03/AllDinosGrey_1_scale.png)
]

---

## No todas las visualizaciones son igual de efectivas

--

![](https://pbs.twimg.com/media/DXrZuSfX0AEjqtM.jpg)

---

## No todas las visualizaciones son igual de efectivas

![](http://3.bp.blogspot.com/-91nBt0UagvM/VMd0gEHuicI/AAAAAAAAKcw/XNyCOWp_JFI/s1600/pie1.jpg)

---

## Visualizaci√≥n efectiva

Los gr√°ficos requieren de nuestra capacidad visual para interpretar figuras geom√©tricas.

--

[Cleveland & McGuill (1985)](https://www.jstor.org/stable/2288400?seq=1#page_scan_tab_contents)

- Las mejores visualizaciones son aquellas que requieren el uso de la "visi√≥n instant√°nea".

- Y no requieren de un esfuerzo visual para ser comprendidas.

--

.center[La "visi√≥n instant√°nea" nos permite evaluar visualmente **patrones geom√©tricos** y dimensionar **magnitudes**]

---

## Visualizaci√≥n efectiva

Cleveland ordena la dificultad de los elementos gr√°ficos basado en la percepci√≥n para estimar variables cuantitativas.

--

De menor a mayor dificultad:

- **Posici√≥n** a lo largo de una escala com√∫n
- **Posici√≥n** en escalas no alineadas pero id√©nticas
- Longitud
- √Ångulo o pendiente
- √Årea
- Volumen, densidad o saturaci√≥n del color
- Tono del color

---

## Visualizaci√≥n efectiva

```{r, out.width = "700px", out.height="290px" , fig.align='center', echo=FALSE}
knitr::include_graphics("clplot.png")
```

---

## Las tortas son para comer...

--

## [*Three reasons that pie charts suck*](https://www.richardhollins.com/blog/why-pie-charts-suck/)

.pull-left[

1. Son malos para comunicar lo b√°sico, a menos que tengan etiquetas.

2. No son buenos para mostrar tendencias (aun cuando lo acompa√±en etiquetas).

3. No sirven para mostrar tendencias cuando se utilizan valores absolutos.
]

.pull-right[![](https://upload.wikimedia.org/wikipedia/commons/thumb/b/b4/Piecharts.svg/2000px-Piecharts.svg.png)
]

---

## Principios generales (para hacer malos gr√°ficos)

- Muestra la menor cantidad de informaci√≥n posible (no es posible leer el gr√°fico sin leer el texto que lo acompa√±a).

--

- Confunde a los dem√°s respecto a lo que quieres mostrar (con etiquetas que no explican nada o caracter√≠sticas que no agregan informaci√≥n).

--

- Usa un gr√°fico de torta (con efectos 3d).

--

- Si comparas m√°s de un gr√°fico, ojal√° utiliza distintas escalas.

---

## Gr√°ficos en R

R tiene distintos paquetes de visualizaci√≥n de datos (`ggplot2`, `lattice`).

--

Pero, ¬øpor qu√© usarlas? R base tiene funciones para hacer gr√°ficos sin necesidad de llamar a otros paquetes:

```{r pressure, fig.align='center', fig.height=3.7, fig.width=3.7, echo=TRUE}
plot(pressure)
```

---

## Gr√°ficos en R

A mayor tiempo invertido, la calidad de los gr√°ficos de `ggplot2` y `lattice` es mucho mayor que la de los gr√°ficos **R** base.

--

Paquetes como `ggplot` siguen una gram√°tica coherente, lo que facilita su aprendizaje. Adem√°s, con poco esfuerzo (aunque m√°s c√≥digo) se obtienen r√°pidamente mejores resultados.

--

```{r, fig.align='center', fig.height=3.7, fig.width=3.7, echo=TRUE}
ggplot(data = pressure) + 
          geom_point(mapping = aes(x = temperature, y = pressure))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## `ggplot2`

`ggplot2` fue desarrollado sobre la base de la "gram√°tica de los gr√°ficos":

--

- Un **sistema coherente** para describir y construir gr√°ficos.

--

Una buena gram√°tica permite **descifrar** de manera f√°cil gr√°ficos complicados:

- Facilita la programaci√≥n de estos.

- Es m√°s sencillo reutilizar el c√≥digo para resolver otros problemas.

--

Bajo esta gram√°tica los gr√°ficos pueden ser descompuestos en un conjunto de par√°metros o capas, las que servir√≠an para describir a *cualquier* gr√°fico.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gram√°tica de los gr√°ficos

Independiente del gr√°fico, siempre se necesitar√°n los mismos elementos para construir uno:

- Datos (`data`)
- Propiedades est√©ticas (`aes`)
- Objeto geom√©trico (`geom`)
- Transformaciones estad√≠sticas (`stat`)
- Escala (`scale`)
- Sistema de coordenadas (`coord`)
- Facetas (`facet`)

--

Puede decirse que el c√≥digo de `ggplot2` funciona agregando capas.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gram√°tica de los gr√°ficos

Si bien no aprenderemos *exactamente* como se hace cada gr√°fico, s√≠ intentaremos conocer que es lo b√°sico que tiene que tener *cualquiera* de estos.

--

La gram√°tica que veremos se puede representar de la siguiente manera:

```{r, echo=TRUE, eval=FALSE}
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(
     mapping = aes(<MAPPINGS>),
     stat = <STAT>, 
     position = <POSITION>
  ) +
  <FACET_FUNCTION> +
  <SCALE_FUNCTION> +
  <THEME_FUNCTION>
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## 1er elemento de esta gram√°tica: ¬°Datos!

### `gapminder` 

Base de datos de Gapminder.org. Contiene informaci√≥n sobre la esperanza de vida, PIB per c√°pita 
 y poblaci√≥n desde 1952 a 2007
 
```{r}
library(gapminder)
```

Anteriormente vimos que una manera de representar la relaci√≥n entre PIB per c√°pita y esperanza de vida era a trav√©s de un gr√°fico de dispersi√≥n de puntos con dos ejes. 

¬øC√≥mo se construir√≠a este gr√°fico?

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 2

Completa lo que falta en el espacio ocupado por los puntos suspensivos.

```{r, echo=TRUE, eval=FALSE}
ggplot(data = ...) +
 geom_point(mapping = aes(x = ..., y = ...))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%


## mini-taller 2 - Soluci√≥n

```{r, echo=TRUE, fig.height=4, fig.align='center'}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = gdpPercap, y = lifeExp))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Los primeros elementos de esta gram√°tica

```{r, echo=TRUE, eval=FALSE}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = gdpPercap, y = lifeExp))
```

**`ggplot`**: crea un sistema de cordenadas al que se le pueden ir agregando capas. El primer argumento de `ggplot()` son los datos para usar en el gr√°fico (`ggplot(data = gapminder)`.

--

**`geom`**: elementos geom√©tricos (puntos, l√≠neas, rect√°ngulos, texto, etc).

Cada funci√≥n `geom` toma un argumento de `mapping`. Este define c√≥mo las variables en el conjunto de datos son mapeadas a elementos gr√°ficos (i.e. especifica lo que vemos en el gr√°fico: puntos, l√≠neas, barras, etc).

--

**`aes`**: propiedad visual de los objetos en el gr√°fico. Los argumentos `x` e `y` de `aes` especifican cuales variables mapear en los ejes *x* e *y* del gr√°fico.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## `gapminder`

Para visualizar mejor la relaci√≥n entre la riqueza de los pa√≠ses y su esperanza de vida transformemos logar√≠tmicamente la variable PIB per c√°pita. 

```{r, echo=TRUE, eval=FALSE}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp))
```

¬øC√≥mo creen que se ver√° ahora el gr√°fico?

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## `gapminder`

```{r, fig.height=4, fig.align='center'}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%


## Elementos est√©ticos (*Aesthetic*)

Dec√≠amos que los elementos est√©ticos corresponden a propiedades visuales de nuestro gr√°fico. Estos permiten mapear variables en propiedades est√©ticas que podemos ver.

Algunas propiedades de los elementos son: `size`, `colour`, `shape`.

--

Por ejemplo, imaginemos que nos interesa identificar por color los distintos continentes en el gr√°fico (`continent`).

```{r, echo=TRUE, eval=FALSE}
# ¬øQu√© falta donde estan los "..."?
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp, 
                          colour = ...))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Elementos est√©ticos (*Aesthetic*)

```{r, fig.height=4, fig.align='center'}
# alpha controla la transparencia
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), 
                      y = lifeExp, 
                     colour = continent, alpha = (1/3)))
```


---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Elementos est√©ticos (*Aesthetic*)

Para mapear una propiedad est√©tica a una variable, es necesario asociar el nombre de esta propiedad a la variable dentro del argumento `aes()`. 

--

`ggplot` autom√°ticamente asignar√° un valor √∫nico a la propiedad est√©tica (en este caso un √∫nico color) a cada valor √∫nico de la variable. Este proceso es conocido como *scaling* (escalamiento).

--

Tambi√©n es posible fijar una propiedad est√©tica de manera manual a cada `geom`. Por ejemplo, se podr√≠a hacer que todos los puntos del gr√°fico fueran rojos.

???
Por defecto se agrega una leyenda que relaciona qu√© niveles de la propiedad est√©tica corresponden a cada valor.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Elementos est√©ticos (*Aesthetic*)

```{r, echo=TRUE, fig.height=4, fig.align='center'}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp), 
                          colour = "red")
```

¬øNotan una diferencia con el c√≥digo del gr√°fico anterior?

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Elementos est√©ticos (*Aesthetic*)

En este caso el color no reporta informaci√≥n sobre alguna variable, sino que s√≥lo cambia la apariencia del gr√°fico.

Para fijar un par√°metro est√©tico de manera manual se debe dejar este como un argumento de la funci√≥n `geom`, y no de la funci√≥n `aes()`.

--

### mini-taller 3

¬øQu√© ocurre si vinculas una propiedad est√©tica a algo como `aes(colour = pop > mean(pop))`?

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 3

```{r, fig.height=4, fig.align='center'}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp, 
                          colour = pop > mean(pop)))
```

--

Para entender mejor el c√≥digo, puedes desglosarlo. Corre, por ejemplo, `gapminder$pop > mean(gapminder$pop)`. 

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 3 - Soluci√≥n

`R` resuelve este c√≥digo el que corresponde a un vector con valores l√≥gicos (`TRUE` y `FALSE`).

En este gr√°fico se diferencia por color entre aquellos pa√≠ses que en determinado a√±o tuvieron una poblaci√≥n mayor al promedio mundial, respecto de los que no cumplen esta condici√≥n.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## no tan mini-taller 4

¬øC√≥mo representar√≠as en el gr√°fico la relaci√≥n entre PIB per c√°pita, esperanza de vida y tama√±o de la poblaci√≥n?

Pista: ¬øQu√© otras propiedades est√©ticas encontramos en `aes()`?

*¬°5 minutos!*

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## no tan mini-taller 4 - Soluci√≥n


```{r, echo=TRUE, fig.height=4, fig.align='center'}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp, 
                    size = pop, colour = continent, alpha = 1/3))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## `ggplot2`: Gr√°ficos como objetos

A diferencia de los gr√°ficos creados con `R` base, los gr√°ficos creados con `ggplot2` se pueden guardar como objeto.

```{r, echo=TRUE}
esperanza_pib <- ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp, 
                          size = pop, colour = continent, alpha = 1/3))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## `ggplot2`: Gr√°ficos como objetos

Para verlo es necesario imprimirlo.

```{r, echo=TRUE, fig.align='center', fig.height=4}
esperanza_pib
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## `ggplot2`: Gr√°ficos como objetos

Esto significa que no tenemos que agregar desde un principio todas las caracter√≠sticas que queremos para nuestro gr√°fico.

Podemos ir construy√©ndolo de a poco, sobreescribiendo el objeto inicial, lo que finalmente puede resultar en un c√≥digo m√°s ordenado y f√°cil de entender.

```{r, echo=TRUE, eval=FALSE}
esperanza_pib <- esperanza_pib + geom(...) + scale_x_continuous(...)
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Transformaciones estad√≠sticas (`Stat`)

**`stat`**: Com√∫nmente representa un resumen estad√≠stico de estos. Un ejemplo de `stat` es `smooth`, la que implica una media condicional suavizada de *y* dado *x*

--

Cada `geom` tiene un `stat` por defecto, por lo que muchas veces no tendremos que indicarlo en nuestro c√≥digo (`R` ya "sabe" qu√© hacer, aunque esto no siempre es lo que queremos ver en nuestro gr√°fico...).

--

En el caso del gr√°fico de dispersi√≥n que estamos usando el `stat` por defecto es `identity`. ¬øA qu√© crees que se refiera?

```{r, eval=FALSE}
geom_point(mapping = aes(...), stat = "identity")
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Transformaciones estad√≠sticas (`Stat`)

`stat = "identity"` implica que los datos que se representan en el gr√°fico corresponden exactamente a los datos que tenemos en nuestra base de datos.

--

En este caso, lo que queremos ver es c√≥mo se ubican los pa√≠ses (como puntos en un gr√°fico) de acuerdo a un sistema de coordenadas definido por los valores de `x = log10(PIB per c√°pita)` e `y = Esperanza de vida` que tenemos originalmente en nuestros datos.

¬øQu√© pasa si queremos ver ahora la media condicional suavizada de *y* dado *x*?

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Transformaciones estad√≠sticas (`Stat`)

`geom_smooth` es otra manera de especificar qu√© queremos ver en un gr√°fico. Particularmente, nos permite ver si existe alg√∫n patr√≥n en la distribuci√≥n de dos variables.

La transformaci√≥n estad√≠stica que utiliza es `smooth`, la que por defecto ajusta a los datos un modelo aditivo generalizado (GAM).

--

¬°Estos valores no est√°n originalmente en nuestros datos!

Este `stat` permite calcular nuevos valores para nuestro gr√°fico. 

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Transformaciones estad√≠sticas (`Stat`)

```{r, echo=TRUE, fig.align='center', fig.height=4.5}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp,
                          colour = continent, size = pop)) + 
  geom_smooth(mapping = aes(x = log10(gdpPercap), y = lifeExp))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Transformaciones estad√≠sticas (`Stat`)

`geom_smooth` utiliza `stat_smooth` por defecto.

`stat_smooth` tambi√©n puede ser un argumento de nuestro gr√°fico, el cual tambi√©n tiene por defecto un `geom`.

--

Gracias a esta caracter√≠stica, muchas veces se puede usar `geom` o `stat` de manera intercambiable.

```{r, eval=FALSE}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp,
                          colour = continent, size = pop)) + 
  stat_smooth(mapping = aes(x = log10(gdpPercap), y = lifeExp))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Transformaciones estad√≠sticas (`Stat`)

```{r, echo=FALSE, fig.align='center', fig.height=6, warning=FALSE, message=FALSE}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp,
                          colour = continent, size = pop)) + 
  stat_smooth(mapping = aes(x = log10(gdpPercap), y = lifeExp))
```

???
Es posible cambiar el m√©todo de ajuste con el argumento `method` de `geom_smooth`.
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp,
                          colour = continent, size = pop)) + 
  stat_smooth(mapping = aes(x = log10(gdpPercap), y = lifeExp), 
              method = "lm")
              
---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Elementos geom√©tricos (`Geom`)

Hasta ahora hemos visto dos: `geom_point` y `geom_smooth`. Pero existen muchos m√°s:

Alguno ejemplos son: 

- `geom_line`

- `geom_bar`

- `geom_density`

- `geom_boxplot`

- `geom_histogram`

- Y muchas [m√°s](https://ggplot2.tidyverse.org/reference/)!

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Elementos geom√©tricos (`Geom`)

Hasta ahora para mostrar diferentes objetos geom√©tricos en un mismo gr√°fico, hemos agregado m√∫ltiples `geom` a la funci√≥n `ggplot()`.

```{r, echo=TRUE, eval=FALSE}
ggplot(data = gapminder) +
 geom_point(mapping = aes(x = log10(gdpPercap), y = lifeExp,
                          colour = continent, size = pop)) + 
  geom_smooth(mapping = aes(x = log10(gdpPercap), y = lifeExp))
```

Sin embargo, esto hace que nuestro c√≥digo sea un poco repetitivo.

--

En `ggplot` es posible fijar un conjunto de propiedades est√©ticas de manera global para todo un gr√°fico. Al mismo tiempo, se pueden agregar otras capas que utilicen otras propiedades e incluso otros datos.

```{r, echo=TRUE, eval=FALSE}
ggplot(data = gapminder, mapping = aes(x = log10(gdpPercap), 
                                       y = lifeExp)) +
 geom_point(mapping = aes(colour = continent, size = pop)) + 
  geom_smooth()
```

???
Cada especificaci√≥n local (a nivel de `geom`) anula para esa capa las propiedades globales.
Las capas en este sentido son independientes entre s√≠.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gr√°ficos de barras (`geom_bar`)

Aunque los gr√°ficos de barra pueden parecer sencillos, resultan ser un ejemplo muy claro para entender la transformaci√≥n estad√≠stica.

--

Para este ejemplo utilizaremos la **ENUSC 2017**.

```{r}
library(haven)
enusc <- read_sav("data/Base de Datos - XIV ENUSC 2017.sav") %>% 
  filter(Kish == 1) %>% 
  select(enc_region, rph_sexo, VP_DC, VA_DC, rph_edad, P13_1_1) %>% 
  mutate(sexo = haven::as_factor(rph_sexo),
         region = haven::as_factor(enc_region),
         vic_hog = haven::as_factor(VA_DC),
         edad = as.numeric(rph_edad))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gr√°ficos de barras (`geom_bar`)

El siguiente gr√°fico muestra el total muestral de victimizados por sexo (Victimizaci√≥n personal).

```{r, echo=TRUE, fig.align='center', fig.height=4}
enusc %>% filter(VP_DC == 1) %>% 
ggplot() + 
  geom_bar(mapping = aes(x = sexo))
```

--

¬øDe donde proviene la variable `count`?

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gr√°ficos de barras (`geom_bar`)

Muchos gr√°ficos, como los de dispersi√≥n, utilizan los valores en bruto de nuestros datos.

--

Otros tipos de gr√°ficos calculan nuevos valores:

- Gr√°ficos de barra, histogramas, compartimentan los datos y luego grafican cuantos casos caen en cada uno de estos compartimentos.

- Para los diagramas de caja (boxplots) se calcula un resumen estad√≠stico de los datos, los que luego son graficados de acuerdo a un formato.

![](https://d33wubrfki0l68.cloudfront.net/70a3b18a1128c785d8676a48c005ee9b6a23cc00/7283c/images/visualization-stat-bar.png)

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gr√°ficos de barras (`geom_bar`)

Para saber que `stat` usa cada `geom` puedes revisar el valor por defecto, preguntando por ejemplo `?geom_bar` 

--

En algunos casos puede que quieras utilizar otro `stat` en vez del que viene por defecto.

--

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%


### mini-taller 5

Utilizando el siguiente conjunto de datos, crea un gr√°fico similar al que ya vimos.

Este conjunto de datos tiene la variable `freq`, que indica el n√∫mero total victimizados ppor sexo.

```{r, echo=TRUE}
demo <- tribble(
  ~sexo,        ~freq,
  "Hombre",     1059,
  "Mujer",      1608
)
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 5 - Soluci√≥n

```{r, fig.height=5}
ggplot(data = demo) +
  geom_bar(mapping = aes(x = sexo, y = freq), 
           stat = "identity")
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gr√°ficos de barras (`geom_bar`)

Otra manera de cambiar el seteo por defecto, es cambiar la variable calculada.

Para ver este aspecto de `geom_bar`, vamos a `?geom_bar` de la ayuda de `R`.

--

Cambiando en la variable y a `..prop..` es posible mostrar la proporci√≥n por grupo

```{r, echo=TRUE, fig.height=3.7}
enusc %>% filter(VP_DC == 1) %>% 
ggplot() +  
  geom_bar(mapping = aes(x = sexo, y = ..prop.., group = 1))
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gr√°ficos de barras (`geom_bar`)

¬øPara qu√© sirve el argumento `group = 1`?

[R for Data Science Solutions](https://jrnold.github.io/r4ds-exercise-solutions/data-visualisation.html#exercise-3.7.4.)

[Respuesta en StackOverflow](https://stackoverflow.com/questions/39878813/ggplot-geom-bar-meaning-of-aesgroup-1/39879232#39879232)

--

Alguien m√°s curioso tambi√©n pudo haberse preguntado, y ¬øpor qu√© se usa `..prop..`? ¬øQu√© son esos puntos?

--

[Respuesta en StackOverflow](https://stackoverflow.com/questions/17502808/double-dots-in-a-ggplot)

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gr√°ficos de barras (`geom_bar`)

Para colorear un gr√°fico de barras se puede usar la propiedad visual `colour` o `fill`.

--
.pull-left[

```{r, fig.height=4}
ggplot(data = enusc) +  
  geom_bar(mapping = 
          aes(x = sexo,
          fill = vic_hog))
```
]

.pull-right[

```{r, fig.height=4}
ggplot(data = enusc) +  
  geom_bar(mapping = 
          aes(x = sexo,
          colour = vic_hog))
```
]

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gr√°fico de barras

El apilamiento es la ejecutado por defecto por el ajuste de posici√≥n especificado por el argumento `position = stack`.

Existen otras para este tipo de gr√°ficos: 

- `position = "fill"`

- `position = "dodge"`

(Existen m√°s! Pero no todas aplican para los gr√°ficos de barra. Ej. `position = "jitter"` para `geom_point`).

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 6

Revisa qu√© hace cada uno de ajustes de posici√≥n para el gr√°fico anterior (`?geom_bar`).

A continuaci√≥n, el c√≥digo para partir:

```{r, echo=TRUE, eval=FALSE}
ggplot(data = enusc) +  
  geom_bar(mapping = aes(x = sexo, fill = vic_hog),
           position = ...)
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 6 - Soluci√≥n

- `position = "fill"`: es como el apilamiento, pero hace que cada barra apilada tenga la misma altura. 

```{r, echo=TRUE, fig.height=3.2}
ggplot(data = enusc) +  
  geom_bar(mapping = aes(x = sexo, fill = vic_hog),
           position = "fill")
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## mini-taller 6 - Soluci√≥n

- `position = "dodge"`: ubica los objetos uno al lado del otro. 

```{r, echo=TRUE, fig.height=3.2}
ggplot(data = enusc) +  
  geom_bar(mapping = aes(x = sexo, fill = vic_hog),
           position = "dodge")
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Escalas (`scales`)

Hasta ahora con los argumentos `mapping = aes()` solamente hemos especificado que una variable debe ser mapeada a un elemento est√©tico.

--

No le hemos dicho a `R` c√≥mo hacer espec√≠ficamente esta transformaci√≥n.

Ej. En los gr√°ficos anteriores no hemos dicho en ning√∫n caso qu√© m√≠nimo y m√°ximo usar en los ejes *x* e *y*, en qu√© puntos deben aparecer las etiquetas en los ejes, cu√°l es el t√≠tulo de cada eje, etc.

--

La conversi√≥n entre las unidades en que vienen los datos (pesos, sexo, etc.) a unidades gr√°ficas se denomina escalado, y es realizada por los argumentos `scales`.

--

Los siguientes argumentos son los m√°s comunes entre las escalas de `ggplot2`:

- **`name`**: argumento que da el nombre al eje o el t√≠tulo de la leyenda.
- **`limits`**: m√≠nimo y m√°ximo de una escala.
- **`breaks`**: los puntos a lo largo de la escala donde las etiquetas deben aparecer.
- **`labels`**: las etiquetas que deber√≠an aparecer en cada corte.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Escalas (`scales`)

¬øSe acuerdan de este gr√°fico?

```{r, echo=TRUE, fig.align='center', fig.height=5}
ggplot(data = gapminder, mapping = aes(x = log10(gdpPercap), 
                                       y = lifeExp)) +
 geom_point(mapping = aes(colour = continent, size = pop)) 
```

Especifiquemos con m√°s claridad c√≥mo cada variable debe ser mapeada como un elemento est√©tico.

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Escalas (`scales`)

```{r, echo=TRUE, fig.align='center', fig.height=5}
ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp)) +
 geom_point(mapping = aes(colour = continent, size = pop)) + 
  scale_x_log10(name = "PIB per capita") + #<<
  scale_y_continuous(name = "Esperanza de vida", #<<
                     breaks = seq(20,90,10)) #<<
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Peque√±o bonus: *Themes*

Hay distintos temas para elegir. Para un lista, click [aqu√≠](https://ggplot2.tidyverse.org/reference/ggtheme.html)

```{r, echo=TRUE, fig.align='center', fig.height=4.5}
ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp)) +
 geom_point(mapping = aes(colour = continent, size = pop)) + 
  scale_x_log10(name = "PIB per capita") + 
  scale_y_continuous(name = "Esperanza de vida") +
  theme_classic() #<<
```


---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Peque√±o bonus: *Facets*

```{r, echo=TRUE, fig.align='center', fig.height=4.5}
ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp, 
                                       colour = country)) +
 geom_point(aes(size = pop), show.legend = FALSE) + 
  scale_colour_manual(values = country_colors) +
  scale_x_log10(name = "PIB per capita") + 
  scale_y_continuous(name = "Esperanza de vida") +
   facet_wrap(~continent) #<<
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## Gram√°tica de los gr√°ficos

¬øHace un poco m√°s de sentido?

```{r, echo=TRUE, eval=FALSE}
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(
     mapping = aes(<MAPPINGS>),
     stat = <STAT>, 
     position = <POSITION>
  ) +
  <FACET_FUNCTION> +
  <SCALE_FUNCTION> +
  <THEME_FUNCTION>
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## ¬øY como guardamos los gr√°ficos?

No guardes gr√°ficos usando el mouse üê≠.

--

La funci√≥n `ggsave()` del paquete `ggplot2` permite resolver esto f√°cilmente.

--

- Si el gr√°fico est√° en tu pantalla:

```{r, eval=FALSE}
ggsave("carpeta/para/graficos/nombre.png")
```

- Si tu gr√°fico est√° asignado a un objeto:

```{r, eval=FALSE}
ggsave(grafico1, file = "carpeta/para/graficos/nombre.png")
```

- Si quieres especificar un tama√±o:

```{r, eval=FALSE}
ggsave(file = "carpeta/para/graficos/nombre.png", width = 6, 
       height = 4)
```

- Tambi√©n puedes usar otro formato (pdf, jpg , entre otros)

```{r, eval=FALSE}
ggsave("carpeta/para/graficos/nombre.pdf")
```

---

background-image: url(https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png)
background-size: 75px
background-position: 93% 8%

## ¬°√öltimo desaf√≠o!

¬°Replicar el gr√°fico de Joy of Stats!

Para esto necesitaremos la librer√≠a `gganimate`.

Tambi√©n hay otras librer√≠as para conseguir lo mismo (`plotly`).

--

Vamos a partir guardando nuestro gr√°fico en un objeto.

```{r}
p <- ggplot(gapminder, aes(gdpPercap, lifeExp, 
                           color = continent)) +
  geom_point(aes(size = pop), show.legend = FALSE) +
  scale_y_continuous(breaks = seq(20,90,10)) +
  scale_size(range = c(2,12)) + 
  scale_x_log10()
```

---

background-image: url(https://i0.wp.com/www.data-imaginist.com/assets/images/gganimate_logo_small.png?w=456&ssl=1)
background-size: 75px
background-position: 93% 8%

## ¬°√öltimo desaf√≠o!

¬°Aqu√≠ viene el c√≥digo para animarlo!

```{r, eval=FALSE, echo=TRUE}
library(gganimate)
p + labs(title = 'A√±o: {frame_time}',
         x = 'PIB per capita',
         y = 'Esperanza de vida') +
  transition_time(year) + 
    ease_aes('linear')
```

---

background-image: url(https://i0.wp.com/www.data-imaginist.com/assets/images/gganimate_logo_small.png?w=456&ssl=1)
background-size: 75px
background-position: 93% 8%

## ¬°√öltimo desaf√≠o!

```{r, echo=FALSE}
library(gganimate)
p + labs(title = 'A√±o: {frame_time}',
         x = 'PIB per capita',
         y = 'Esperanza de vida') +
  transition_time(year) + 
    ease_aes('linear')
```


---

## Ejercicios para la casa! üè†

### Ejercicio 1

Utilizando la base de datos de la **ENUSC 2017**, grafica la victimizaci√≥n personal por tramos de edad. Utiliza como referencia los siguientes tramos:

- 15 a 19 a√±os
- 20 a 35 a√±os
- 36 a 45 a√±os
- 46 a 55 a√±os
- 56 a 65 a√±os
- 66 a√±os y m√°s

Utiliza el tipo de gr√°fico que creas sea el m√°s adecuado para mostrar estos datos. 

- Considera solo los datos a nivel muestral y descriptivo. 

- Recuerda que debes filtrar tus datos por el informante Kish.

---

## Ejercicios para la casa! üè†

### Ejercicio 2

Compara en un solo gr√°fico el porcentaje de personas v√≠ctimas de un delito (victimizaci√≥n personal) por regi√≥n y el porcentaje de personas que creen ser√°n nuevamente v√≠ctimas de un delito en los pr√≥ximos 12 meses. 

- Considera solo los datos a nivel muestral y descriptivo. 

- Recuerda que debes filtrar tus datos por el informante Kish.

- üëÄ: La pregunta P13_1_1 tiene valores `NA`.

---

## Ejercicios para la casa! üè†

### Ejercicio 2

**Puedes usar si quieres el siguiente c√≥digo para partir**

```{r, eval=FALSE}
# Convertir p13 en factor y VP_DC en factor
enusc$p13 <- as_factor(enusc$P13_1_1)
enusc$vic_per <- as_factor(enusc$VP_DC)
# Dejar como NA categor√≠as distintas a Si y No
enusc$p13[enusc$p13 != "Si" & enusc$p13 != "No"] <- NA
# Borrar niveles que ahora son NA con fct_drop de forcats
enusc$p13 <- fct_drop(enusc$p13, c("No sabe", "Sin dato",
                                   "No responde"))

# Calcular percepci√≥n P13 por regi√≥n
enusc %>% filter(!is.na(p13)) %>% 
  group_by(region, p13) %>% 
  summarise(total = n()) %>% 
  mutate(perc_vic = 100 * (total/ sum(total)))
```

